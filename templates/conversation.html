{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">{{ get_message('conversation_with').format(other.username) }}</h2>
<div class="card mb-3" style="max-width:700px;margin:auto;">
  <div class="card-body" style="min-height:300px;">
    {% for msg in messages %}
      <div class="d-flex mb-3 {% if msg.sender.id == session.get('user_id') %}justify-content-end{% else %}justify-content-start{% endif %}">
        {% if msg.sender.id != session.get('user_id') %}
          <a href="{{ url_for('user_profile', user_id=msg.sender.id) }}">
            <img src="{{ url_for('uploaded_file', filename=msg.sender.avatar) if msg.sender.avatar else url_for('static', filename='default_avatar.png') }}" class="rounded-circle me-2 shadow" style="width:36px;height:36px;object-fit:cover;border:2px solid #eee;">
          </a>
        {% endif %}
        <div>
          <div class="p-2 rounded {% if msg.sender.id == session.get('user_id') %}bg-primary text-white{% else %}bg-light border{% endif %}" style="max-width:350px;word-break:break-all;">
            <div class="small fw-bold mb-1"><span class="fw-bold" style="font-size:1.15em;">{{ msg.sender.username }}</span></div>
            {% if msg.content %}
              <div class="mb-2">{{ msg.content }}</div>
            {% endif %}
            {% if msg.image_filename %}
              <div class="mb-2">
                <img src="{{ url_for('uploaded_file', filename=msg.image_filename) }}" 
                     class="img-fluid rounded" 
                     style="max-width: 100%; max-height: 300px; cursor: pointer;" 
                     onclick="openImageModal(this.src)"
                     alt="消息图片">
              </div>
            {% endif %}
            <div class="text-end text-muted small mt-1">{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
          </div>
        </div>
        {% if msg.sender.id == session.get('user_id') %}
          <a href="{{ url_for('user_profile', user_id=msg.sender.id) }}">
            <img src="{{ url_for('uploaded_file', filename=msg.sender.avatar) if msg.sender.avatar else url_for('static', filename='default_avatar.png') }}" class="rounded-circle ms-2" style="width:40px;height:40px;object-fit:cover;" alt="{{ get_message('avatar') }}">
          </a>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <div class="card-footer bg-white">
    <form method="post" enctype="multipart/form-data" class="d-flex align-items-end">
      <div class="flex-grow-1 me-2">
        <textarea name="content" rows="2" class="form-control mb-2" style="resize:none;" placeholder="{{ get_message('input_message') }}"></textarea>
        <div class="d-flex align-items-center">
          <input type="file" name="image" id="image" class="form-control form-control-sm me-2" accept="image/*" style="max-width: 200px;">
          <small class="text-muted">{{ get_message('image_upload_hint') if get_message('image_upload_hint') else '支持 PNG、JPG、JPEG、GIF、WEBP 格式' }}</small>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">{{ get_message('send') }}</button>
    </form>
  </div>
</div>
<a href="{{ url_for('message_list') }}" class="btn btn-outline-secondary mt-3">{{ get_message('back_to_message_list') }}</a>

<!-- 图片查看模态框 -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">{{ get_message('view_image') if get_message('view_image') else '查看图片' }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid" alt="消息图片">
      </div>
    </div>
  </div>
</div>

<script>
function openImageModal(imageSrc) {
  document.getElementById('modalImage').src = imageSrc;
  var modal = new bootstrap.Modal(document.getElementById('imageModal'));
  modal.show();
}

// 文件选择预览
document.getElementById('image').addEventListener('change', function(e) {
  var file = e.target.files[0];
  if (file) {
    // 可以在这里添加文件大小检查
    if (file.size > 5 * 1024 * 1024) { // 5MB限制
      alert('{{ get_message("file_too_large") if get_message("file_too_large") else "文件大小不能超过5MB" }}');
      this.value = '';
      return;
    }
  }
});
</script>
{% endblock %} 